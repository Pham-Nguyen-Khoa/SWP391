extends ../../layouts/default.pug
include ../../mixins/alert.pug
block main
    +alert-success("5000")
    +alert-error('5000')
    .block-sider(style="width:90%;margin-left:180px;")
        .dashboard-doctor
            .dashboard-doctor-header.row.mb-5
                .col-md-4
                    .card
                        .card-body.d-flex.align-items-center
                            i.fas.fa-users.text-4xl.text-blue-500.mr-4
                            .card-content
                                h2 Tổng số lịch hẹn
                                p #{appointmentsTotal}+
                            
                .col-md-4
                    .card
                        .card-body.d-flex.align-items-center
                            i.fas.fa-user-plus.text-4xl.text-blue-500.mr-4
                            .card-content   
                                h2 Lịch hẹn hôm nay
                                p #{appointmentsToday.length}
                .col-md-4
                    .card
                        .card-body.d-flex.align-items-center
                            i.fas.fa-user-plus.text-4xl.text-blue-500.mr-4
                            .card-content   
                                h2 Thông tin lịch hẹn hôm nay
                                    if(appointmentsToday.length > 0)
                                        table.table-mini.mt-3(style="width: 100%;")
                                            thead 
                                                tr 
                                                    th Tên khách hàng
                                                    th Thời gian
                                                    th Chi tiết
                                            tbody 
                                                each appointment in appointmentsToday
                                                    tr 
                                                        td #{appointment.Name}
                                                        td #{appointment.Shift}
                                                        td 
                                                            a.btn.btn-outline-primary.btn-sm(href=`/doctor/appointment/detail/${appointment.AppointmentID}`) Xem chi tiết
                                    else 
                                        p 0
                //- .col-md-4
                //-     .card
                //-         .card-body.d-flex.align-items-center
                //-             i.fas.fa-calendar-check.text-4xl.text-blue-500.mr-4 
                //-             .card-content   
                //-                 h2 Cuộc hẹn hôm nay
                //-                 p 085

            .dashboard-doctor-chart
                .dashboard-doctor-chart-content.row
                    .chart.col-md-4.appointment-content.px-2.appointment-today
                        .card(style=(listFeedback.length > 0) ? "height: auto;" : "height: auto;")
                            strong Feedback
                            .feedback-chart(style="height: 250px;")
                                canvas#chartContainer2(style="position: relative; height:400px; width:100%")
                            if(listFeedback.length > 0)
                                table#feedback-table
                                    thead
                                        tr
                                            th Khách hàng
                                            th Nội dung
                                            th Số sao
                                            th Chi tiết
                                    tbody
                                        each feedback,index in listFeedback
                                            tr 
                                                td #{feedback.FullName}
                                                td #{feedback.Content}
                                                td 
                                                    .star-rating
                                                        - for (var i = 0; i < feedback.Star; i++)
                                                            span.star.filled ★
                                                        - for (var i = 0; i < 5 - feedback.Star; i++)
                                                            span.star ★
                                                td 
                                                    a(href=`/doctor/appointment/detail/${feedback.AppointmentID}`) Xem chi tiết
                            else 
                                p.no-feedback Không có feedback nào
                            if(allFeedback.length > limit)
                                button.btn.btn-primary#openFeedbackModal Xem tất cả feedback
                    .chart.col-md-8.appointment-content.appointment-today.px-2
                        .card(style="height: 586px;")
                            .filter-appointment-chart.d-flex.justify-content-between
                                strong Biểu đồ lịch hẹn theo thời gian
                                div.button-group
                                    button.btn.btn-outline-primary(type="button" id="filterByDay") Theo Ngày
                                    button.btn.btn-outline-primary.m-2.active(type="button" id="filterByMonth") Theo Tháng
                                    button.btn.btn-outline-primary(type="button" id="filterByYear") Theo Năm
                            canvas#appointmentLineChart(style="height: 300px; width: 100%;")
    
        #feedbackModal.modal.fade
            .modal-dialog.modal-lg
                .modal-content
                    .modal-header
                        h5.modal-title Tất cả Feedback
                        button.close(type="button" data-dismiss="modal" aria-label="Close")
                            span(aria-hidden="true") &times;
                    .modal-body
                        table.table.table-hover
                            thead
                                tr
                                    th Khách hàng
                                    th Nội dung
                                    th Số sao
                                    th Ngày
                                    th Chi tiết
                            tbody
                                each feedback in allFeedback
                                    tr 
                                        td.font-weight-bold #{feedback.FullName}
                                        td.feedback-content #{feedback.Content}
                                        td 
                                            .star-rating
                                                - for (var i = 0; i < feedback.Star; i++)
                                                    span.star.filled ★
                                                - for (var i = 0; i < 5 - feedback.Star; i++)
                                                    span.star ☆
                                        td.text-muted #{feedback.FormattedDate}
                                        td 
                                            a.btn.btn-outline-primary.btn-sm(href=`/doctor/appointment/detail/${feedback.AppointmentID}`) Xem chi tiết
                    .modal-footer
                        button.btn.btn-secondary(type="button" data-dismiss="modal") Đóng
           



    script(src="https://cdn.jsdelivr.net/npm/chart.js")
    script.
            const star = !{JSON.stringify(star)}
            const appointmentData = !{JSON.stringify(appointmentData)}
            const appointmentDataMonthCount = !{JSON.stringify(appointmentDataMonthCount)}

        //- const ctx = document.getElementById('myChart').getContext('2d');
        //- const myChart = new Chart(ctx, {
        //-     type: 'pie', // Changed from 'bar' to 'pie'
        //-     data: {
        //-         labels: ['Property 1', 'Property 2', 'Property 3'], // Updated labels
        //-         datasets: [{
        //-             label: 'My Dataset', // Updated label
        //-             data: [10, 20, 30], // Updated data for three properties
        //-             backgroundColor: [  
        //-                 'rgba(255, 99, 132, 0.2)',
        //-                 'rgba(54, 162, 235, 0.2)',
        //-                 'rgba(255, 206, 86, 0.2)'
        //-             ],
        //-             borderColor: [  
        //-                 'rgba(255, 99, 132, 1)',
        //-                 'rgba(54, 162, 235, 1)',
        //-                 'rgba(255, 206, 86, 1)'
        //-             ],
        //-             borderWidth: 1  
        //-         }]      
        //-     },
        //-     options: {
        //-         // ... existing options ...
        //-     }
        //- });


            


            const ctx2 = document.getElementById('chartContainer2').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['5 sao', '4 sao', '3 sao', '2 sao', '1 sao'],
                    datasets: [{
                        label: 'Phân bố đánh giá',
                        data: [star.star5, star.star4, star.star3, star.star2, star.star1], // Replace with actual data
                        backgroundColor: [
                            'rgba(0, 200, 0, 0.8)',   // 5 stars - Green
                            'rgba(100, 200, 0, 0.8)', // 4 stars - Light green
                            'rgba(200, 200, 0, 0.8)', // 3 stars - Yellow
                            'rgba(255, 150, 0, 0.8)', // 2 stars - Orange
                            'rgba(255, 50, 0, 0.8)'   // 1 star - Red
                        ]
                    }]
                },
                 options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Số lượng đánh giá',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Số sao',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Thống kê Feedback khách hàng',
                            font: {
                                size: 18
                            }
                        }
                    }
                }
            });
            const modalFeedBack = document.getElementById('openFeedbackModal');
            if(modalFeedBack){
                modalFeedBack.addEventListener('click', function() {
                    $('#feedbackModal').modal('show');
                });
            }
            const monthArray = [];
            for (let i = 1; i <= 12; i++) {
                monthArray.push(i.toString()); // Chuyển số thành chuỗi và thêm vào mảng
            }
            

            let appointmentLineChart
            let appointmentLineChartCtx = document.getElementById('appointmentLineChart').getContext('2d');
            const filterByMonth = document.getElementById('filterByMonth');
          
            if(filterByMonth){
                filterByMonth.addEventListener('click', function() {
                    filterByMonth.classList.add('active');
                    filterByDay.classList.remove('active');
                    filterByYear.classList.remove('active');
                    appointmentLineChart.destroy();
                    updateChart(monthArray,appointmentDataMonthCount);
                });
            }
             window.onload = updateChart(monthArray,appointmentDataMonthCount);
            function updateChart(type,data){
                
        
                   appointmentLineChart = new Chart(appointmentLineChartCtx, {
                    type: 'line', // Định dạng biểu đồ là đường
                    data: {
                        labels: type, // Nhãn cho trục x
                        datasets: [{
                            label: 'Số lượng lịch hẹn', // Nhãn cho tập dữ liệu
                            data: data, // Sử dụng dữ liệu được truyền vào
                            borderColor: 'rgba(75, 192, 192, 1)', // Màu đường
                            backgroundColor: 'rgba(75, 192, 192, 0.2)', // Màu nền
                            fill: true // Điền màu dưới đường
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Thêm dòng này để cho phép điều chỉnh kích thước
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Số lượng'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tháng'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            },
                            title: {
                                display: true,
                                text: 'Biểu đồ lịch hẹn theo thời gian'
                            }
                        }
                    }
                });
                appointmentLineChart.update();
            }


           
            
            const filterByDay = document.getElementById('filterByDay');
            if(filterByDay){
                  let dayArray = [];
            for (let i = 1; i <= 31; i++) {
                dayArray.push(i.toString()); 
            }
                
                let appointmentDataDayCount = new Array(31).fill(0); 
                appointmentData.forEach(appointment => {
                    const date = new Date(appointment.Date);
                    const day = date.getDate() - 1; 

                    if(day >= 0 && day < 31){ 
                    appointmentDataDayCount[day] += 1; 
                    }
                });
                console.log(appointmentDataDayCount)
                
                filterByDay.addEventListener('click', function() {
                    filterByDay.classList.add('active');
                    filterByMonth.classList.remove('active');
                    filterByYear.classList.remove('active');
                    appointmentLineChart.destroy();
                    updateChart(dayArray,appointmentDataDayCount);
                    appointmentLineChart.update();
                });
            }

            const filterByYear = document.getElementById('filterByYear');
            if(filterByYear){
                 let yearArray = [];
                 const yearCurrent = new Date().getFullYear();
                 console.log(yearCurrent)
            for (let i = 5; i >= 0; i--) {
                yearArray.push(yearCurrent - i); 
            }
            console.log(yearArray)
            let appointmentDataYearCount = new Array(6).fill(0); 
                appointmentData.forEach((appointment,index) => {
                    const date = new Date(appointment.Date);
                    const year = date.getFullYear(); 
                    const yearIndex = yearCurrent - year + 5;
                    if(year >= yearCurrent - 5 && year <= yearCurrent){ 
                    appointmentDataYearCount[yearIndex] += 1; 
                    }
                });
                console.log(appointmentDataYearCount)
                filterByYear.addEventListener('click', function() {
                    filterByYear.classList.add('active');
                    filterByMonth.classList.remove('active');
                    filterByDay.classList.remove('active');
                    appointmentLineChart.destroy();
                    updateChart(yearArray,appointmentDataYearCount);
                    appointmentLineChart.update();
                });
            }



        //- document.getElementById('filterByDay').addEventListener('click', function() {
        //-     // Logic để lọc dữ liệu theo ngày
        //-     const daysArray = [];
        //-     for (let i = 1; i <= 31; i++) {
        //-         daysArray.push(i.toString()); // Chuyển số thành chuỗi và thêm vào mảng
        //-     }
        //-     appointmentLineChart.destroy();
        //-     const appointmentLineChartCtx = document.getElementById('appointmentLineChart').getContext('2d');
        //-     const appointmentLineChart = new Chart(appointmentLineChartCtx, {
        //-         type: 'line', // Định dạng biểu đồ là đường
        //-         data: {
        //-             labels: daysArray,
        //-             datasets: [{
        //-                 label: 'Số lượng lịch hẹn', // Nhãn cho tập dữ liệu
        //-                 data: appointmentDataMonthCount , // Dữ liệu mẫu
            
        //-     //- updateChart('day');
                    
        //- }); 
        //- })

                    //- document.getElementById('filterByMonth').addEventListener('click', function() {
                    //-     // Logic để lọc dữ liệu theo tháng
                    //-     appointmentLineChart.destroy();
                    //-     updateChart('month');
                    //- });

                    //- document.getElementById('filterByYear').addEventListener('click', function() {
                    //-     // Logic để lọc dữ liệu theo năm
                    //-     appointmentLineChart.destroy();
                    //-     updateChart('year');
                    //- });