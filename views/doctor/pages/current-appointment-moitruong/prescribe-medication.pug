extends ../../layouts/default.pug
include ../../mixins/mixin-title.pug

block main
  .container-fluid
    +title("Kê Đơn Thuốc")
    form#prescriptionForm(action="/doctor/current-appointment/payment" method="POST")
      input#previousPageData(type="hidden" name="previousPageData")
      input#selectedMedications(type="hidden" name="selectedMedications")
      
      // Container for medication cards
      .medication-cards

      .text-center.mt-4
        button.btn.btn-lg(type="submit" style="background-color: #4294b1c7; color: black; padding: 10px;") Thanh toán
        a.btn.btn-lg(href="/doctor/current-appointment" style="background-color: #4294b1c7; color: black; padding: 10px;") Quay lại

  script.
    const medications = !{JSON.stringify(listMedicine)};
    const pondCount = localStorage.getItem('pondCount'); 

    const medicationCardsContainer = document.querySelector('.medication-cards');

    for (let i = 1; i <= pondCount; i++) {
      const card = document.createElement('div');
      card.className = 'card';
      card.style = 'box-shadow: 0px 1px 15px 4px rgb(0 0 0 / 30%); border-radius: 8px; border: none; margin-bottom: 30px; background-color: #f7fbff; padding-bottom: 20px;';
      card.innerHTML = `
        <div class="card-header" style="background-color: #C7E3ED; font-weight: bold; font-size: 1.3em; padding: 15px; border-top-left-radius: 8px; border-top-right-radius: 8px;">Đơn thuốc cho hồ ${i}</div>
        <div class="card-body">
          <div class="form-group">
            <label for="medicationSelect${i}">Chọn thuốc</label>
            <select class="form-control medication-select" id="medicationSelect${i}" name="medicationSelect${i}">
              <option value="">-- Chọn thuốc --</option>
            </select>
          </div>
          <table class="table prescription-table" id="prescriptionTable${i}">
            <thead>
              <tr>
                <th>Hình ảnh</th>
                <th>Tên thuốc</th>
                <th>Hướng dẫn sử dụng</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <!-- Các hàng sẽ được thêm vào bằng JavaScript -->
            </tbody>
          </table>
        </div>
      `;
      medicationCardsContainer.appendChild(card);
    }

    document.querySelectorAll('.medication-select').forEach(selectElement => {
      medications.forEach(med => {
        const option = document.createElement('option');
        option.value = med.MedicineID;
        option.textContent = med.Name;
        selectElement.appendChild(option);
      });

      selectElement.addEventListener('change', function() {
        const selectedMed = medications.find(med => med.MedicineID == this.value);
        if (selectedMed) {
          const tableId = this.id.replace('medicationSelect', 'prescriptionTable');
          const prescriptionTable = document.getElementById(tableId).getElementsByTagName('tbody')[0];
          addOrUpdateMedicationInTable(selectedMed, prescriptionTable, tableId);
          this.value = '';
        }
      });
    });

    function addOrUpdateMedicationInTable(medication, prescriptionTable, tableId) {
      const existingRow = Array.from(prescriptionTable.rows).find(row => row.cells[1].textContent === medication.Name);

      if (!existingRow) {
        const row = prescriptionTable.insertRow();
        row.dataset.medicineId = medication.MedicineID; 
        row.innerHTML = `
          <td><img src="${medication.Image}" alt="${medication.Name}" style="width: 100px; height: 100px; object-fit: cover;"></td>
          <td>${medication.Name}</td>
          <td>${medication.toUse}</td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="removeMedication(this, '${tableId}', '${medication.MedicineID}')">Xóa</button></td>
        `;
        saveFormData();
      }
    }

    function removeMedication(button, tableId, medicationID) {
      const row = button.closest('tr');
      row.remove();
      saveFormData();
    }

    function saveFormData() {
      const prescriptionData = [];
      for (let i = 1; i <= pondCount; i++) {
        const prescriptionTable = document.getElementById(`prescriptionTable${i}`).getElementsByTagName('tbody')[0];
        const medicationIDs = Array.from(prescriptionTable.rows).map(row => row.dataset.medicineId); // Lấy MedicineID từ dataset của hàng
        prescriptionData.push({
          pond: i,
          medications: medicationIDs
        });
      }
      localStorage.setItem('prescriptionData', JSON.stringify(prescriptionData));
    }

    function restoreFormData() {
      const savedData = localStorage.getItem('prescriptionData');
      if (savedData) {
        const data = JSON.parse(savedData);
        data.forEach(prescription => {
          const prescriptionTable = document.getElementById(`prescriptionTable${prescription.pond}`).getElementsByTagName('tbody')[0];
          prescription.medications.forEach(medicationID => {
            const medication = medications.find(med => med.MedicineID == medicationID);
            if (medication) {
              const row = prescriptionTable.insertRow();
              row.dataset.medicineId = medication.MedicineID; // Lưu MedicineID vào dataset của hàng
              row.innerHTML = `
                <td><img src="${medication.Image}" alt="${medication.Name}" style="width: 100px; height: 100px; object-fit: cover;"></td>
                <td>${medication.Name}</td>
                <td>${medication.toUse}</td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeMedication(this, 'prescriptionTable${prescription.pond}', '${medication.MedicineID}')">Xóa</button></td>
              `;
            }
          });
        });
      }
    }

    window.addEventListener('load', restoreFormData);

    const prescriptionForm = document.getElementById('prescriptionForm');
    prescriptionForm.addEventListener('submit', (e) => {
      saveFormData();
      const prescriptionData = localStorage.getItem('prescriptionData');
      const previousPageData = localStorage.getItem('appointmentData');
      console.log(previousPageData)
      console.log(prescriptionData)
      document.getElementById('previousPageData').value = previousPageData;
      document.getElementById('selectedMedications').value = prescriptionData;
    });