extends ../../layouts/default.pug
include ../../mixins/mixin-title.pug
include ../../../admin/mixins/pagination.pug
include ../../mixins/alert.pug

block main
    .block-footer(style="height: 86vh ; margin-bottom: 20vh")
        +title("Lịch Hẹn Của Bạn")
        +alert-success("5000")
        +alert-error("5000")
        .filter-section
            form#filterForm(action="/koi/my-appointment" method="GET")
                .row
                    .col-md-3.col-sm-6
                        .form-group
                            label(for="serviceFilter") Dịch vụ
                            select#serviceFilter.form-control(name="serviceFilter" )
                                option(value="") Tất cả
                                option(value="DV0001" selected=serviceFilter == "DV0001") Khám Sức Khỏe
                                option(value="DV0002" selected=serviceFilter == "DV0002") Cải Thiện Môi Trường
                                option(value="DV0003" selected=serviceFilter == "DV0003") Tư Vấn Online
                    .col-md-3.col-sm-6
                        .form-group
                            label(for="dateFilter") Ngày
                            input#dateFilter.form-control(type="date" name="dateFilter" value=dateFilter)
                    .col-md-3.col-sm-6
                        .form-group
                            label(for="statusFilter") Trạng thái
                            select#statusFilter.form-control(name="statusFilter")
                                option(value="" selected=statusFilter == "") Tất cả
                                option(value="Pending" selected=statusFilter == "Pending") Chờ duyệt
                                option(value="Accepted" selected=statusFilter == "Accepted") Đã tiếp nhận
                                option(value="Ready" selected=statusFilter == "Ready") Sẵn sàng
                                option(value="Process" selected=statusFilter == "Process") Đang thực hiện
                                option(value="Successed" selected=statusFilter == "Successed") Đã hoàn thành
                                option(value="Cancle" selected=statusFilter == "Cancle") Bị Hủy
                    .col-md-3.col-sm-6
                        .form-group
                            label &nbsp;
                            button.btn.btn-primary.btn-block(type="submit") 
                                i.fas.fa-filter.mr-2
                                | Lọc
        .container-table 
            table.table.table-striped.table-bordered.table-my-appointment
                thead 
                    tr 
                        th STT
                        th Ngày
                        th
                            |   Dịch vụ
                            i.fas.fa-filter.ml-1#serviceFilterIcon
                        th Nơi khám
                        th Loại Đơn
                        th Trạng thái 
                        th Khác
                tbody 
                    if(listAppointment && listAppointment.length == 0)
                        tr
                            td(colspan="7").text-center.font-weight-bold Không có đơn hàng nào

                    else
                        each item,index in listAppointment
                            tr 
                                td #{(currentPage-1)*limit + index + 1}
                                td #{item.DateFormat}  
                                if(item.ServiceID == "DV0001")
                                    td Khám Sức Khỏe
                                if(item.ServiceID == "DV0002")
                                    td Cải Thiện Môi Trường
                                if(item.ServiceID == "DV0003")
                                    td Tư Vấn Online
                                if(item.ServiceID =="DV0003")
                                    td Online 
                                if(item.Address == null && item.ServiceID !="DV0003")
                                    td Khám tại trung tâm 
                                if(item.Address != null && item.ServiceID =="DV0002")
                                    td Tại nhà
                                if(item.Address != null && item.ServiceID =="DV0001")
                                    td Tại nhà
                                if(item.ServiceID =="DV0003")
                                    td Tư vấn 
                                else 
                                    td Lịch hẹn
                                if(item.Process =="Pending")
                                    td 
                                        p.process Chờ duyệt
                                if(item.Process =="Accepted")
                                    td 
                                        p.process Đã tiếp nhận
                                if(item.Process =="Ready")
                                    td 
                                        p.process Sẵn sàng
                                if(item.Process =="Process")
                                    td 
                                        p.process Đang thực hiện
                                if(item.Process =="Successed")
                                    td
                                        p.process Đã hoàn thành
                                if(item.Process =="Cancle")
                                    td 
                                        p.process Bị Hủy 
                                td 
                                    a(href=`/koi/my-appointment/detail/${item.AppointmentID}` value=`/koi/my-appointment/detail/${item.AppointmentID}` button-delete class="btn btn-info") Chi tiết 
            +pagination(totalPages, currentPage, "/koi/my-appointment")  
        script(src="/admin/js/pagination.general.js") 
        script(src="https://code.jquery.com/jquery-3.6.0.min.js")
        script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js")
        script.
            //-  $(document).ready(function() {
            //-     $('#serviceFilterIcon').click(function() {
            //-         Swal.fire({
            //-             title: 'Lọc theo dịch vụ',
            //-             html: `
            //-                 <div>
            //-                     <label><input type="checkbox" value="DV0001"> Khám Sức Khỏe</label><br>
            //-                     <label><input type="checkbox" value="DV0002"> Cải Thiện Môi Trường</label><br>
            //-                     <label><input type="checkbox" value="DV0003"> Tư Vấn Online</label>
            //-                 </div>
            //-             `,
            //-             showCancelButton: true,
            //-             confirmButtonText: 'Lọc',
            //-             cancelButtonText: 'Hủy',
            //-             preConfirm: () => {
            //-                 return Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            //-             }
            //-         }).then((result) => {
            //-             if (result.isConfirmed) {
            //-                 filterServices(result.value);
            //-             }
            //-         });
            //-     });

            //-     function filterServices(selectedServices) {
            //-         let visibleCount = 0;
            //-         $('table.table-my-appointment tbody tr').each(function(index) {
            //-             var serviceCell = $(this).find('td:nth-child(3)');
            //-             var serviceId = getServiceId(serviceCell.text());
            //-             if (selectedServices.length === 0 || selectedServices.includes(serviceId)) {
            //-                 $(this).show();
            //-                 visibleCount++;
            //-                 $(this).find('td:first-child').text(visibleCount);
            //-             } else {
            //-                 $(this).hide();
            //-             }
            //-         });
            //-          updatePagination(visibleCount);
            //-          showPage(1);
            //-     }

            //-     function getServiceId(serviceName) {
            //-         switch(serviceName.trim()) {
            //-             case 'Khám Sức Khỏe': return 'DV0001';
            //-             case 'Cải Thiện Môi Trường': return 'DV0002';
            //-             case 'Tư Vấn Online': return 'DV0003';
            //-             default: return '';
            //-         }
            //-     }
            //- });

            //- function updatePagination(visibleCount) {
            //-     const itemsPerPage = #{limit}; // Số lượng item trên mỗi trang
            //-     const totalPages = Math.ceil(visibleCount / itemsPerPage);
                
            //-     let paginationHtml = '';
            //-     for (let i = 1; i <= totalPages; i++) {
            //-         paginationHtml += `<li class="page-item ${i === 1 ? 'active' : ''}"><a class="page-link" href="#">${i}</a></li>`;
            //-     }
                
            //-     $('.pagination').html(paginationHtml);
                
            //-     // Cập nhật sự kiện click cho các nút phân trang
            //-     $('.pagination .page-link').click(function(e) {
            //-         e.preventDefault();
            //-         const page = parseInt($(this).text());
            //-         showPage(page);
            //-     });
            //- }

            //- function showPage(page) {
            //-     const itemsPerPage = #{limit};
            //-     let visibleCount = 0;
                
            //-     $('table.table-my-appointment tbody tr:visible').each(function(index) {
            //-         if (index >= (page - 1) * itemsPerPage && index < page * itemsPerPage) {
            //-             $(this).show();
            //-             visibleCount++;
            //-             $(this).find('td:first-child').text(visibleCount + (page - 1) * itemsPerPage);
            //-         } else {
            //-             $(this).hide();
            //-         }
            //-     });
                
            //-     $('.pagination .page-item').removeClass('active');
            //-     $(`.pagination .page-item:nth-child(${page})`).addClass('active');
            //- }
